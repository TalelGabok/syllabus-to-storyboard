<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syllabus to Missions Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        let apiKey = '';
        let apiProvider = 'openai';
        let syllabusData = null;
        let selectedTopics = [];
        let generatedMissions = [];
        let isGenerating = false;
        let currentMissionIndex = 0;

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen">
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 text-white py-6 px-8 shadow-lg">
                        <div class="max-w-7xl mx-auto">
                            <h1 class="text-3xl font-bold">üìö Syllabus to Missions Generator</h1>
                            <p class="text-indigo-100 mt-1">Transform training syllabi into production-ready microlearning missions</p>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-8">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-l-4 border-indigo-800">
                            <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è API Configuration</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Provider</label>
                                    <select id="apiProvider" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="openai">OpenAI (GPT-4)</option>
                                        <option value="anthropic">Anthropic (Claude)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key *</label>
                                    <input type="password" id="apiKey" placeholder="Enter your API key" 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-800">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 class="text-xl font-semibold mb-4">üì§ Step 1: Upload Syllabus JSON</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload JSON File</label>
                                    <input type="file" id="fileUpload" accept=".json" 
                                           class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Or Paste JSON</label>
                                    <textarea id="jsonPaste" rows="4" placeholder="Paste syllabus JSON here..."
                                              class="w-full px-4 py-2 border rounded-lg text-sm font-mono"></textarea>
                                    <button onclick="loadPastedJSON()" 
                                            class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                        Load JSON
                                    </button>
                                </div>
                            </div>
                            ${syllabusData ? `
                                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                                    <div class="font-semibold text-green-800">‚úì Syllabus Loaded: ${syllabusData.course_title}</div>
                                    <p class="text-sm text-green-700 mt-1">
                                        ${syllabusData.curriculum?.length || 0} curriculum topics available
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        ${syllabusData ? `
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-xl font-semibold mb-4">‚úÖ Step 2: Select Topics to Generate</h2>
                                <p class="text-sm text-gray-600 mb-4">Select which curriculum topics to generate as missions (max 9 min each)</p>
                                <div class="space-y-3">
                                    ${syllabusData.curriculum.map((topic, idx) => `
                                        <label class="flex items-start space-x-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                                            <input type="checkbox" 
                                                   id="topic-${idx}"
                                                   ${selectedTopics.includes(idx) ? 'checked' : ''}
                                                   onchange="toggleTopic(${idx})"
                                                   class="mt-1 w-5 h-5 text-indigo-600 rounded">
                                            <div>
                                                <div class="font-medium text-gray-800">${topic}</div>
                                                <div class="text-xs text-gray-500">Mission ${idx + 1}</div>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                                <button onclick="generateMissions()" 
                                        ${isGenerating || selectedTopics.length === 0 ? 'disabled' : ''}
                                        class="mt-6 w-full py-4 bg-gradient-to-r from-indigo-900 to-indigo-800 text-white rounded-lg font-semibold text-lg hover:from-indigo-800 hover:to-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                                    ${isGenerating ? `‚è≥ Generating Mission ${currentMissionIndex + 1} of ${selectedTopics.length}...` : `üöÄ Generate ${selectedTopics.length} Mission${selectedTopics.length !== 1 ? 's' : ''}`}
                                </button>
                            </div>
                        ` : ''}

                        ${generatedMissions.length > 0 ? `
                            <div class="space-y-6">
                                <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-indigo-800">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h2 class="text-2xl font-bold text-indigo-900">‚úì Missions Generated</h2>
                                            <p class="text-gray-600">${generatedMissions.length} mission${generatedMissions.length !== 1 ? 's' : ''} ready for production</p>
                                        </div>
                                        <div class="flex gap-3">
                                            <button onclick="downloadAllJSON()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                                ‚¨áÔ∏è All JSON
                                            </button>
                                            <button onclick="downloadAllText()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                                ‚¨áÔ∏è All Text
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                ${generatedMissions.map((mission, idx) => `
                                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-400">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="text-xl font-bold text-gray-800">Mission ${idx + 1}: ${mission.mission_title}</h3>
                                                <p class="text-sm text-gray-600 mt-1">${mission.slides?.length || 0} slides | Est. ${Math.round((mission.slides?.length || 0) * 37.5 / 60 * 10) / 10} min</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="downloadMissionJSON(${idx})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                                                    JSON
                                                </button>
                                                <button onclick="downloadMissionText(${idx})" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600">
                                                    Text
                                                </button>
                                                <button onclick="downloadMissionCSV(${idx})" class="px-3 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600">
                                                    CSV
                                                </button>
                                            </div>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="bg-gray-50 p-4 rounded">
                                                <h4 class="font-semibold text-gray-800 mb-2">Introduction</h4>
                                                <p class="text-sm text-gray-700">${mission.introduction}</p>
                                            </div>

                                            <div>
                                                <h4 class="font-semibold text-gray-800 mb-2">Slide Outline</h4>
                                                <div class="overflow-x-auto">
                                                    <table class="w-full text-sm border">
                                                        <thead class="bg-gray-100">
                                                            <tr>
                                                                <th class="border px-3 py-2 text-left">Slide</th>
                                                                <th class="border px-3 py-2 text-left">Title</th>
                                                                <th class="border px-3 py-2 text-left">Bullets</th>
                                                                <th class="border px-3 py-2 text-left">Voice-Over Prompt</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${mission.slides.map((slide, i) => `
                                                                <tr>
                                                                    <td class="border px-3 py-2">${i + 1}</td>
                                                                    <td class="border px-3 py-2 font-medium">${slide.title}</td>
                                                                    <td class="border px-3 py-2">${slide.bullets.join('<br>')}</td>
                                                                    <td class="border px-3 py-2 text-gray-600">${slide.voiceover_prompt}</td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="bg-blue-50 p-4 rounded">
                                                    <h4 class="font-semibold text-gray-800 mb-2">Learner Steps</h4>
                                                    <ul class="text-sm text-gray-700 space-y-1">
                                                        ${mission.learner_steps.map(step => `<li>‚Ä¢ ${step}</li>`).join('')}
                                                    </ul>
                                                </div>

                                                <div class="bg-green-50 p-4 rounded">
                                                    <h4 class="font-semibold text-gray-800 mb-2">Habits</h4>
                                                    <ul class="text-sm text-gray-700 space-y-1">
                                                        ${mission.habits.daily ? `<li>‚Ä¢ <strong>Daily:</strong> ${mission.habits.daily}</li>` : ''}
                                                        ${mission.habits.weekly ? `<li>‚Ä¢ <strong>Weekly:</strong> ${mission.habits.weekly}</li>` : ''}
                                                        ${mission.habits.monthly ? `<li>‚Ä¢ <strong>Monthly:</strong> ${mission.habits.monthly}</li>` : ''}
                                                        ${mission.habits.quarterly ? `<li>‚Ä¢ <strong>Quarterly:</strong> ${mission.habits.quarterly}</li>` : ''}
                                                    </ul>
                                                </div>
                                            </div>

                                            <div class="bg-purple-50 p-4 rounded">
                                                <h4 class="font-semibold text-gray-800 mb-2">Chat Prompt</h4>
                                                <p class="text-sm text-gray-700">${mission.chat_prompt}</p>
                                            </div>

                                            <div class="bg-orange-50 p-4 rounded">
                                                <h4 class="font-semibold text-gray-800 mb-2">Mentor Questions</h4>
                                                <ul class="text-sm text-gray-700 space-y-1">
                                                    ${mission.mentor_questions.map(q => `<li>‚Ä¢ ${q}</li>`).join('')}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            const apiProviderEl = document.getElementById('apiProvider');
            const apiKeyEl = document.getElementById('apiKey');
            const fileUploadEl = document.getElementById('fileUpload');

            if (apiProviderEl) {
                apiProviderEl.value = apiProvider;
                apiProviderEl.onchange = (e) => {
                    apiProvider = e.target.value;
                };
            }

            if (apiKeyEl) {
                apiKeyEl.value = apiKey;
                apiKeyEl.oninput = (e) => {
                    apiKey = e.target.value;
                };
            }

            if (fileUploadEl) {
                fileUploadEl.onchange = handleFileUpload;
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        syllabusData = JSON.parse(e.target.result);
                        selectedTopics = [];
                        generatedMissions = [];
                        render();
                    } catch (error) {
                        alert('Error parsing JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadPastedJSON() {
            const jsonText = document.getElementById('jsonPaste').value;
            if (!jsonText.trim()) {
                alert('Please paste JSON first');
                return;
            }
            try {
                syllabusData = JSON.parse(jsonText);
                selectedTopics = [];
                generatedMissions = [];
                render();
            } catch (error) {
                alert('Error parsing JSON: ' + error.message);
            }
        }

        function toggleTopic(index) {
            if (selectedTopics.includes(index)) {
                selectedTopics = selectedTopics.filter(i => i !== index);
            } else {
                selectedTopics.push(index);
            }
            render();
        }

        async function generateMissions() {
            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }

            if (selectedTopics.length === 0) {
                alert('Please select at least one topic');
                return;
            }

            isGenerating = true;
            render();

            generatedMissions = [];

            for (let i = 0; i < selectedTopics.length; i++) {
                const topicIndex = selectedTopics[i];
                currentMissionIndex = i;
                render();
                
                const topic = syllabusData.curriculum[topicIndex];
                
                const prompt = `You are an expert instructional designer creating microlearning missions.

Create a production-ready mission document for this training topic:

SYLLABUS CONTEXT:
Course: ${syllabusData.course_title}
Overall Objectives: ${syllabusData.objectives.join(', ')}
Target Audience: ${syllabusData.target_audience}
Training Method: ${syllabusData.training_method}

TOPIC TO DEVELOP:
${topic}

MISSION REQUIREMENTS:
- Max 9 minutes (12-18 slides at 30-45 seconds each)
- Adapt slide flow based on content type (conceptual vs. procedural vs. behavioral)
- Voice-over prompts should be reflective questions, NOT full scripts

Generate a JSON object with this EXACT structure:
{
  "mission_title": "Clear, compelling title for this topic",
  "introduction": "2-3 sentence paragraph introducing the topic and why it matters",
  "slides": [
    {
      "slide_number": 1,
      "title": "Slide title",
      "bullets": ["Bullet 1", "Bullet 2", "Bullet 3"],
      "voiceover_prompt": "Reflective question or thinking prompt"
    }
  ],
  "learner_steps": [
    "Read the material in this mission",
    "Watch the presentation video (5-7 minutes)",
    "Interact with the chat activity",
    "Reflect on and answer the mentor questions"
  ],
  "chat_prompt": "One engaging question about applying this topic",
  "mentor_questions": [
    "Question 1 about application",
    "Question 2 about challenges",
    "Question 3 about implementation",
    "Question 4 about making it sustainable"
  ],
  "habits": {
    "daily": "Daily habit suggestion or null",
    "weekly": "Weekly habit suggestion or null", 
    "monthly": "Monthly habit suggestion or null",
    "quarterly": "Quarterly habit suggestion or null"
  }
}

CRITICAL: Return ONLY valid JSON, no other text.`;

                try {
                    let response;

                    if (apiProvider === 'openai') {
                        response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4o',
                                messages: [
                                    { role: 'system', content: 'You are an expert instructional designer. Always respond with valid JSON only.' },
                                    { role: 'user', content: prompt }
                                ],
                                temperature: 0.7
                            })
                        });
                    } else {
                        response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': apiKey,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: 'claude-sonnet-4-20250514',
                                max_tokens: 4096,
                                messages: [{ role: 'user', content: prompt }]
                            })
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`API Error ${response.status}`);
                    }

                    const data = await response.json();
                    let content = apiProvider === 'openai' 
                        ? data.choices[0].message.content 
                        : data.content[0].text;

                    content = content.trim();
                    if (content.startsWith('```json')) {
                        content = content.replace(/^```json\n/, '').replace(/\n```$/, '');
                    } else if (content.startsWith('```')) {
                        content = content.replace(/^```\n/, '').replace(/\n```$/, '');
                    }

                    const mission = JSON.parse(content);
                    generatedMissions.push(mission);

                } catch (error) {
                    alert(`Error generating mission ${topicIndex + 1}: ${error.message}`);
                    break;
                }
            }

            isGenerating = false;
            currentMissionIndex = 0;
            render();
        }

        function downloadMissionJSON(index) {
            const mission = generatedMissions[index];
            const blob = new Blob([JSON.stringify(mission, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mission_${index + 1}_${mission.mission_title.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadMissionText(index) {
            const mission = generatedMissions[index];
            let text = `Mission ${index + 1}: ${mission.mission_title}\n\n`;
            text += `Introduction\n${mission.introduction}\n\n`;
            text += `Slide Outline\n`;
            text += `Slide\tTitle\tSlide Bullets\tVoice-Over Prompt\n`;
            mission.slides.forEach((slide, i) => {
                text += `${i + 1}\t${slide.title}\t${slide.bullets.join('\n')}\t${slide.voiceover_prompt}\n`;
            });
            text += `\nLearner Steps\n${mission.learner_steps.map(s => '‚Ä¢ ' + s).join('\n')}\n\n`;
            text += `Chat Prompt\n${mission.chat_prompt}\n\n`;
            text += `Mentor Questions\n${mission.mentor_questions.map(q => '‚Ä¢ ' + q).join('\n')}\n\n`;
            text += `Habits\n`;
            if (mission.habits.daily) text += `‚Ä¢ Daily: ${mission.habits.daily}\n`;
            if (mission.habits.weekly) text += `‚Ä¢ Weekly: ${mission.habits.weekly}\n`;
            if (mission.habits.monthly) text += `‚Ä¢ Monthly: ${mission.habits.monthly}\n`;
            if (mission.habits.quarterly) text += `‚Ä¢ Quarterly: ${mission.habits.quarterly}\n`;

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mission_${index + 1}_${mission.mission_title.replace(/\s+/g, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadMissionCSV(index) {
            const mission = generatedMissions[index];
            const headers = ['Slide', 'Title', 'Slide Bullets', 'Voice-Over Prompt'];
            const rows = mission.slides.map((s, i) => [
                i + 1,
                s.title,
                s.bullets.join(' | '),
                s.voiceover_prompt
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mission_${index + 1}_Slides_${mission.mission_title.replace(/\s+/g, '_')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadAllJSON() {
            const blob = new Blob([JSON.stringify(generatedMissions, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `All_Missions_${syllabusData.course_title.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadAllText() {
            let allText = '';
            generatedMissions.forEach((mission, index) => {
                allText += `Mission ${index + 1}: ${mission.mission_title}\n\n`;
                allText += `Introduction\n${mission.introduction}\n\n`;
                allText += `Slide Outline\n`;
                allText += `Slide\tTitle\tSlide Bullets\tVoice-Over Prompt\n`;
                mission.slides.forEach((slide, i) => {
                    allText += `${i + 1}\t${slide.title}\t${slide.bullets.join('\n')}\t${slide.voiceover_prompt}\n`;
                });
                allText += `\nLearner Steps\n${mission.learner_steps.map(s => '‚Ä¢ ' + s).join('\n')}\n\n`;
                allText += `Chat Prompt\n${mission.chat_prompt}\n\n`;
                allText += `Mentor Questions\n${mission.mentor_questions.map(q => '‚Ä¢ ' + q).join('\n')}\n\n`;
                allText += `Habits\n`;
                if (mission.habits.daily) allText += `‚Ä¢ Daily: ${mission.habits.daily}\n`;
                if (mission.habits.weekly) allText += `‚Ä¢ Weekly: ${mission.habits.weekly}\n`;
                if (mission.habits.monthly) allText += `‚Ä¢ Monthly: ${mission.habits.monthly}\n`;
                if (mission.habits.quarterly) allText += `‚Ä¢ Quarterly: ${mission.habits.quarterly}\n`;
                allText += '\n\n' + '='.repeat(80) + '\n\n';
            });

            const blob = new Blob([allText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `All_Missions_${syllabusData.course_title.replace(/\s+/g, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        render();
    </script>
</body>
</html>
