<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syllabus to Missions Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        let state = {
            apiKey: '',
            apiProvider: 'openai',
            syllabus: null,
            selectedTopics: [],
            missions: [],
            isGenerating: false,
            currentMissionIndex: 0,
            editingIndex: null,
            chatHistory: [],
            isProcessingChat: false
        };

        function render() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen">
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 text-white py-6 px-8">
                        <div class="max-w-7xl mx-auto">
                            <h1 class="text-3xl font-bold">Syllabus to Missions Generator</h1>
                            <p class="text-indigo-100 mt-1">Transform syllabi into microlearning missions</p>
                        </div>
                    </div>
                    <div class="max-w-7xl mx-auto p-8">
                        ${renderAPI()}
                        ${renderUpload()}
                        ${renderTopics()}
                        ${renderMissions()}
                    </div>
                </div>
            `;
            attachListeners();
        }

        function renderAPI() {
            return `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="provider" class="px-4 py-2 border rounded">
                            <option value="openai" ${state.apiProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                            <option value="anthropic" ${state.apiProvider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                        </select>
                        <input type="password" id="apiKey" value="${state.apiKey}" placeholder="API Key" class="px-4 py-2 border rounded">
                    </div>
                </div>
            `;
        }

        function renderUpload() {
            return `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Upload Syllabus</h2>
                    <input type="file" id="fileUpload" accept=".json" class="w-full px-4 py-2 border rounded mb-4">
                    <textarea id="jsonPaste" rows="3" placeholder="Or paste JSON..." class="w-full px-4 py-2 border rounded mb-2"></textarea>
                    <button onclick="loadJSON()" class="px-4 py-2 bg-indigo-600 text-white rounded">Load JSON</button>
                    ${state.syllabus ? `<div class="mt-4 p-4 bg-green-50 rounded">Loaded: ${state.syllabus.course_title}</div>` : ''}
                </div>
            `;
        }

        function renderTopics() {
            if (!state.syllabus) return '';
            return `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Select Topics</h2>
                    ${state.syllabus.curriculum.map((topic, i) => `
                        <label class="flex items-center p-3 border rounded mb-2 cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" ${state.selectedTopics.includes(i) ? 'checked' : ''} 
                                   onchange="toggleTopic(${i})" class="w-5 h-5 mr-3">
                            <span>${topic}</span>
                        </label>
                    `).join('')}
                    <button onclick="generateMissions()" 
                            ${state.isGenerating || state.selectedTopics.length === 0 ? 'disabled' : ''}
                            class="mt-4 w-full py-3 bg-indigo-900 text-white rounded disabled:opacity-50">
                        ${state.isGenerating ? `Generating ${state.currentMissionIndex + 1}/${state.selectedTopics.length}...` : `Generate ${state.selectedTopics.length} Missions`}
                    </button>
                </div>
            `;
        }

        function renderMissions() {
            if (state.missions.length === 0) return '';
            return `
                <div class="space-y-6">
                    ${state.missions.map((m, i) => state.editingIndex === i ? renderEditMode(m, i) : renderViewMode(m, i)).join('')}
                </div>
            `;
        }

        function renderViewMode(m, i) {
            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between mb-4">
                        <h3 class="text-xl font-bold">Mission ${i + 1}: ${m.mission_title}</h3>
                        <div class="flex gap-2">
                            <button onclick="editMission(${i})" class="px-3 py-1 bg-indigo-500 text-white rounded text-sm">Edit</button>
                            <button onclick="downloadJSON(${i})" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">JSON</button>
                            <button onclick="downloadCSV(${i})" class="px-3 py-1 bg-green-500 text-white rounded text-sm">CSV</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <p class="text-sm">${m.introduction}</p>
                    </div>
                    <table class="w-full text-sm border">
                        <thead><tr class="bg-gray-100">
                            <th class="border p-2">Slide</th><th class="border p-2">Title</th>
                            <th class="border p-2">Bullets</th><th class="border p-2">Prompt</th>
                        </tr></thead>
                        <tbody>
                            ${m.slides.map((s, si) => `
                                <tr><td class="border p-2">${si + 1}</td>
                                <td class="border p-2">${s.title}</td>
                                <td class="border p-2">${s.bullets.join('<br>')}</td>
                                <td class="border p-2">${s.voiceover_prompt}</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderEditMode(m, i) {
            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold mb-4">Editing Mission ${i + 1}</h3>
                    <input type="text" value="${m.mission_title}" onchange="updateField(${i}, 'mission_title', this.value)" 
                           class="w-full px-3 py-2 border rounded mb-3" placeholder="Title">
                    <textarea rows="2" onchange="updateField(${i}, 'introduction', this.value)"
                              class="w-full px-3 py-2 border rounded mb-4">${m.introduction}</textarea>
                    
                    ${m.slides.map((s, si) => `
                        <div class="mb-3 p-3 bg-gray-50 rounded">
                            <input value="${s.title}" onchange="updateSlide(${i}, ${si}, 'title', this.value)"
                                   class="w-full px-2 py-1 border rounded mb-2">
                            <textarea rows="2" onchange="updateSlide(${i}, ${si}, 'bullets', this.value.split('\\n'))"
                                      class="w-full px-2 py-1 border rounded mb-2">${s.bullets.join('\n')}</textarea>
                            <input value="${s.voiceover_prompt}" onchange="updateSlide(${i}, ${si}, 'voiceover_prompt', this.value)"
                                   class="w-full px-2 py-1 border rounded">
                        </div>
                    `).join('')}

                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-semibold mb-2">AI Assistant</h4>
                        <div class="bg-gray-50 p-3 rounded mb-2 max-h-40 overflow-y-auto">
                            ${state.chatHistory.length === 0 ? '<p class="text-sm text-gray-500">Ask AI to revise...</p>' :
                              state.chatHistory.map(msg => `<div class="text-sm mb-1"><strong>${msg.role}:</strong> ${msg.content}</div>`).join('')}
                            ${state.isProcessingChat ? '<div class="text-sm text-blue-600">‚è≥ AI is thinking...</div>' : ''}
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatInput" placeholder="e.g., Make slide 2 shorter"
                                   ${state.isProcessingChat ? 'disabled' : ''}
                                   class="flex-1 px-3 py-2 border rounded disabled:bg-gray-100" onkeypress="if(event.key==='Enter')chat(${i})">
                            <button onclick="chat(${i})" ${state.isProcessingChat ? 'disabled' : ''}
                                    class="px-4 py-2 bg-green-600 text-white rounded disabled:opacity-50">
                                ${state.isProcessingChat ? 'Processing...' : 'Send'}
                            </button>
                        </div>
                    </div>

                    <button onclick="editMission(null)" class="w-full mt-4 py-2 bg-gray-600 text-white rounded">Done</button>
                </div>
            `;
        }

        function attachListeners() {
            const provider = document.getElementById('provider');
            const apiKey = document.getElementById('apiKey');
            const fileUpload = document.getElementById('fileUpload');
            
            if (provider) provider.onchange = e => { state.apiProvider = e.target.value; };
            if (apiKey) apiKey.oninput = e => { state.apiKey = e.target.value; };
            if (fileUpload) fileUpload.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        state.syllabus = JSON.parse(ev.target.result);
                        render();
                    };
                    reader.readAsText(file);
                }
            };
        }

        function loadJSON() {
            const text = document.getElementById('jsonPaste').value;
            if (text) {
                state.syllabus = JSON.parse(text);
                render();
            }
        }

        function toggleTopic(i) {
            if (state.selectedTopics.includes(i)) {
                state.selectedTopics = state.selectedTopics.filter(x => x !== i);
            } else {
                state.selectedTopics.push(i);
            }
            render();
        }

        async function generateMissions() {
            state.isGenerating = true;
            state.missions = [];
            render();

            for (let i = 0; i < state.selectedTopics.length; i++) {
                state.currentMissionIndex = i;
                render();
                
                const topic = state.syllabus.curriculum[state.selectedTopics[i]];
                const prompt = `Create a microlearning mission for: ${topic}

Context: ${state.syllabus.course_title}
Audience: ${state.syllabus.target_audience}

Return JSON:
{
  "mission_title": "title",
  "introduction": "2-3 sentences",
  "slides": [{"slide_number": 1, "title": "...", "bullets": ["..."], "voiceover_prompt": "question?"}],
  "learner_steps": ["..."],
  "chat_prompt": "...",
  "mentor_questions": ["..."],
  "habits": {"daily": "...", "weekly": "...", "monthly": null, "quarterly": null}
}`;

                const response = await callAI(prompt);
                state.missions.push(response);
            }

            state.isGenerating = false;
            render();
        }

        async function callAI(prompt) {
            const url = state.apiProvider === 'openai' 
                ? 'https://api.openai.com/v1/chat/completions'
                : 'https://api.anthropic.com/v1/messages';
            
            const headers = state.apiProvider === 'openai'
                ? {'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}`}
                : {'Content-Type': 'application/json', 'x-api-key': state.apiKey, 'anthropic-version': '2023-06-01'};
            
            const body = state.apiProvider === 'openai'
                ? {model: 'gpt-4o', messages: [{role: 'user', content: prompt}]}
                : {model: 'claude-sonnet-4-20250514', max_tokens: 4096, messages: [{role: 'user', content: prompt}]};

            const res = await fetch(url, {method: 'POST', headers, body: JSON.stringify(body)});
            const data = await res.json();
            let content = state.apiProvider === 'openai' ? data.choices[0].message.content : data.content[0].text;
            content = content.trim().replace(/^```json\n?/, '').replace(/\n?```$/, '');
            return JSON.parse(content);
        }

        function editMission(i) {
            state.editingIndex = i;
            state.chatHistory = [];
            render();
        }

        function updateField(i, field, value) {
            state.missions[i][field] = value;
        }

        function updateSlide(i, si, field, value) {
            state.missions[i].slides[si][field] = value;
        }

        async function chat(i) {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if (!msg) return;
            
            state.chatHistory.push({role: 'user', content: msg});
            state.isProcessingChat = true;
            input.value = '';
            render();

            const prompt = `Update this mission: ${JSON.stringify(state.missions[i])}\n\nChange: ${msg}\n\nReturn updated JSON only.`;
            const updated = await callAI(prompt);
            state.missions[i] = updated;
            state.chatHistory.push({role: 'ai', content: 'Updated!'});
            state.isProcessingChat = false;
            render();
        }

        function downloadJSON(i) {
            const blob = new Blob([JSON.stringify(state.missions[i], null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Mission_${i + 1}.json`;
            a.click();
        }

        function downloadCSV(i) {
            const m = state.missions[i];
            const csv = ['Slide,Title,Bullets,Prompt', 
                ...m.slides.map((s, si) => `${si + 1},"${s.title}","${s.bullets.join(' | ')}","${s.voiceover_prompt}"`)
            ].join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Mission_${i + 1}.csv`;
            a.click();
        }

        render();
    </script>
</body>
</html>
